from flask import Flask, request
import requests

app = Flask(__name__)

# توکن رباتتو اینجا بذار
TOKEN = 'BCHJI0MEPIEOGKSGXIAMYMCQLKXJNFPWGIEHZUQFLDFYUQQJTPZASYJAZUSWDLLP'

# لینک پایه روبیکا بات
API_URL = f'https://botapi.rubika.ir/v3/{TOKEN}'

# زمانی که پیام جدیدی به ربات فرستاده میشه، روبیکا این endpoint رو صدا میزنه
@app.route('/rubika-bot', methods=['POST'])
def webhook():
    data = request.json

    try:
        # چک می‌کنیم پیام جدید از کاربر اومده
        update = data.get('update')
        if update and update['type'] == 'NewMessage':
            chat_id = update['chat_id']
            text = update['new_message']['text']

            # ارسال پاسخ
            send_message(chat_id, f"پیامتو گرفتم: {text}")
        
        return 'ok'
    except Exception as e:
        print("Error:", e)
        return 'error'

# تابع ارسال پیام
def send_message(chat_id, text):
    url = f"{API_URL}/sendMessage"
    payload = {
        "chat_id": chat_id,
        "text": text
    }
    headers = {'Content-Type': 'application/json'}
    requests.post(url, json=payload, headers=headers)

# اجرای برنامه
if __name__ == '__main__':
    app.run(debug=True)